from flask import Flask, render_template, jsonify, send_file
import subprocess
import pymysql
from datetime import datetime
import pandas as pd

app = Flask(__name__, template_folder='/var/www/html', static_folder='/var/www/html')

# Database configuration
db_host = "localhost"
db_user = "kenneth"
db_password = "061499kJ"
db_name = "ROV_DATA"

def connect_to_database():
    return pymysql.connect(host=db_host, user=db_user, password=db_password, database=db_name)

def get_data_for_today():
    connection = connect_to_database()
    try:
        with connection.cursor() as cursor:
            # Get today's date
            today_date = datetime.now().strftime("%Y-%m-%d")
            
            # SQL query to fetch data for today
            sql = f"SELECT Test_Num, Voltage, pH, Temp, AirQuality, DATE_FORMAT(Date, '%Y-%m-%d') as Date FROM ROV_DATA WHERE DATE(Date) = '{today_date}'"
            cursor.execute(sql)
            data = cursor.fetchall()
            return data
    finally:
        connection.close()

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/data')
def get_data():
    data = get_data_for_today()
    if data:
        return jsonify(data)
    else:
        return jsonify({'error': 'No data found for today.'})

@app.route('/start_script')
def open_script():
    script_name = "/var/www/html/ROV.py"
    subprocess.Popen(["python", script_name])
    return 'Script opened'

@app.route('/stop_script')
def close_script():
    script_name = "/var/www/html/ROV.py"
    subprocess.Popen(["pkill", "-f", script_name])
    return 'Script closed'
    
@app.route('/download_files')
def download_files():
    data = get_data_for_today()
    current_date = datetime.now().strftime("%Y-%m-%d")
    df = pd.DataFrame(data)
    excel_writer = pd.ExcelWriter(f'{current_date}.xlsx', engine = 'xlswriter')
    df.to_excel(excel_writer,index = False)
    excel_writer.save()
    return send_file(f'{current_date}.xlsx', as_attachment=True)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001)
